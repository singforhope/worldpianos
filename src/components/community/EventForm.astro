---
// Import Supabase client and dataService functions
import { supabase } from '../../utils/supabase';
import { getAllPianos } from '../../utils/dataService';

// Import our custom components
import SupabaseClient from './SupabaseClient.astro';
import LocationPicker from './LocationPicker.astro';
import ImageUploader from './ImageUploader.astro';
import FormStatusMessage from './FormStatusMessage.astro';
import EventService from './EventService.astro';

// Authentication is now properly implemented
const DEVELOPMENT_MODE = false; // No longer bypassing authentication
const SERVICE_ROLE_KEY = ''; // Not using service role key anymore

// Check if the form is being displayed in a modal
const isModal = Astro.url.searchParams.get('modal') === 'true';

interface Props {
  formTitle?: string;
  contactEmail?: string;
  isModal?: boolean;
}

const { formTitle = "Add a New Event", contactEmail = "it@singforhope.org", isModal: propsIsModal = false } = Astro.props;

// Use either the URL parameter or the prop to determine if it's in a modal
const displayInModal = isModal || propsIsModal;

// Get pianos from Supabase instead of mock data
const pianos = await getAllPianos();
---

{DEVELOPMENT_MODE && (
  <div class="alert alert-warning mb-4">
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
    <div>
      <h3 class="font-bold">Development Mode</h3>
      <div class="text-xs">Authentication is bypassed. This should NOT be used in production!</div>
    </div>
  </div>
)}

<div class="card bg-base-100 shadow-xl">
  <div class="card-body">
    <!-- Duplicate submission message -->
    <div id="duplicate-submission-message" class="hidden">
      <div class="alert alert-warning shadow-lg fixed top-4 left-1/2 transform -translate-x-1/2 z-50 w-auto max-w-md fade-in">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
          <span>Form is already being submitted, please wait...</span>
        </div>
        <div class="flex-none">
          <button onclick="window.hideDuplicateSubmissionMessage()" class="btn btn-sm btn-ghost">Ã—</button>
        </div>
      </div>
    </div>
    
    <form id="event-form" class="space-y-6" enctype="multipart/form-data">
      <!-- Event Name -->
      <div class="form-control w-full">
        <label for="event-name" class="label">
          <span class="label-text font-medium">Name of Event</span>
          <span class="label-text-alt text-error">*</span>
        </label>
        <input type="text" id="event-name" name="eventName" placeholder="Enter event name" class="input input-bordered w-full" required />
      </div>
      
      <!-- Location -->
      <LocationPicker id="event-location" label="Location" required={true} />
      
      <!-- Event Date and Time -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="form-control w-full">
          <label for="event-date" class="label">
            <span class="label-text font-medium">Event Date</span>
            <span class="label-text-alt text-error">*</span>
          </label>
          <input type="date" id="event-date" name="eventDate" class="input input-bordered w-full" required />
        </div>
        
        <div class="form-control w-full">
          <label for="event-time" class="label">
            <span class="label-text font-medium">Event Time</span>
            <span class="label-text-alt text-error">*</span>
          </label>
          <input type="time" id="event-time" name="eventTime" class="input input-bordered w-full" required />
        </div>
      </div>
      
      <!-- Related Piano -->
      <div class="form-control w-full">
        <label for="related-piano" class="label">
          <span class="label-text font-medium">Related Piano</span>
          <span class="label-text-alt text-error">*</span>
        </label>
        <select id="related-piano" name="relatedPiano" class="select select-bordered w-full" required>
          <option value="" disabled selected>Select a piano</option>
          {pianos.map((piano) => (
            <option value={piano.id}>{piano.name} - {piano.location}</option>
          ))}
        </select>
      </div>
      
      <!-- Description -->
      <div class="form-control w-full">
        <label for="description" class="label">
          <span class="label-text">Description</span>
          <span class="label-text-alt text-error">*</span>
        </label>
        <textarea id="description" name="description" placeholder="Describe the event" class="textarea textarea-bordered w-full h-32" required></textarea>
      </div>
      
      <!-- Picture Upload -->
      <ImageUploader id="event-picture" name="eventPicture" label="Event Picture" required={false} />
      
      <!-- Event Type -->
      <div class="form-control w-full">
        <label for="event-type" class="label">
          <span class="label-text">Event Type</span>
          <span class="label-text-alt text-error">*</span>
        </label>
        <select id="event-type" name="eventType" class="select select-bordered w-full" required>
          <option value="" disabled selected>Select event type</option>
          <option value="Concert">Concert</option>
          <option value="Recital">Recital</option>
          <option value="Festival">Festival</option>
          <option value="Workshop">Workshop</option>
          <option value="Competition">Competition</option>
          <option value="Other">Other</option>
        </select>
      </div>
      
      <!-- Form Status Messages -->
      <FormStatusMessage id="form-status" />
      
      <!-- Submit Button -->
      <div class="form-control mt-8">
        <button type="submit" id="submit-btn" class="btn btn-primary btn-lg w-full md:w-1/3 mx-auto">
          <span id="submit-text">Submit Event</span>
          <span id="loading-spinner" class="loading loading-spinner hidden"></span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- No external libraries needed for simple success message -->

<!-- Include the Supabase client -->
<SupabaseClient developmentMode={DEVELOPMENT_MODE} serviceRoleKey={SERVICE_ROLE_KEY} />

<!-- Include the Event Service -->
<EventService developmentMode={DEVELOPMENT_MODE} />

<!-- Add Toastify CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />

<!-- Add Toastify JS -->
<script is:inline src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<style>
  .fade-in {
    animation: fadeIn 0.3s ease-in-out;
  }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translate(-50%, -20px);
    }
    to {
      opacity: 1;
      transform: translate(-50%, 0);
    }
  }
</style>

<!-- Auth utilities script -->
<script>
  // Import auth and profile directly (not dynamically)
  import { auth, profile } from '../../utils/auth';
  
  // Add TypeScript declaration to extend window interface
  interface WindowWithAuth extends Window {
    worldPianosAuth?: {
      auth: typeof auth;
      profile: typeof profile;
    }
  }
  
  // Expose auth utilities to the window for use in the inline script
  (window as WindowWithAuth).worldPianosAuth = { auth, profile };
</script>

<script define:vars={{ DEVELOPMENT_MODE, displayInModal }}>
  // Make development mode available globally
  window.developmentMode = DEVELOPMENT_MODE;
  
  // Create global static flags to prevent duplicate submissions
  if (typeof window !== 'undefined') {
    // Initialize global flags if they don't exist
    window.worldPianosGlobals = window.worldPianosGlobals || {};
    window.worldPianosGlobals.eventFormState = window.worldPianosGlobals.eventFormState || {
      isSubmitting: false,
      formSubmitted: false,
      eventCreated: false,
      submittedEventId: null,
      lastSubmissionTime: 0
    };
    
    // Create a showToast function if it doesn't exist
    if (!window.showToast) {
      window.showToast = function(message, type = 'info') {
        // Check if Toastify is available
        if (typeof Toastify === 'function') {
          Toastify({
            text: message,
            duration: 3000, // 3 seconds
            close: true, // Show close button
            gravity: "top",
            position: "right",
            className: `toastify-${type}`,
            onClick: function() { this.hideToast(); }, // Click to dismiss
            style: {
              background: type === "success" ? "#36d399" : 
                        type === "error" ? "#f87272" : 
                        type === "warning" ? "#fbbd23" : "#3abff8",
              borderRadius: "8px",
              boxShadow: "0 4px 6px rgba(0, 0, 0, 0.1)"
            }
          }).showToast();
        } else {
          // Fallback to alert if Toastify is not available
          console.log(`Toast (${type}): ${message}`);
        }
      };
    }
    
    // Create a function to hide duplicate submission message
    window.hideDuplicateSubmissionMessage = function() {
      const msgEl = document.getElementById('duplicate-submission-message');
      if (msgEl) {
        msgEl.style.display = 'none';
      }
    };
    
    // Create a function to show duplicate submission message
    window.showDuplicateSubmissionMessage = function() {
      const msgEl = document.getElementById('duplicate-submission-message');
      if (msgEl) {
        msgEl.style.display = 'block';
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
          msgEl.style.display = 'none';
        }, 3000);
      }
    };
  }
  
  // Function to ensure auth utilities are available
  function ensureAuthUtilities(maxAttempts = 10, interval = 300) {
    return new Promise((resolve, reject) => {
      let attempts = 0;
      
      const checkAuth = () => {
        if (window.worldPianosAuth && window.worldPianosAuth.auth && window.worldPianosAuth.profile) {
          console.log('Auth utilities found on window');
          resolve(window.worldPianosAuth);
        } else {
          attempts++;
          if (attempts >= maxAttempts) {
            console.error('Auth utilities not found after', maxAttempts, 'attempts');
            reject(new Error('Auth utilities not found on window after multiple attempts'));
          } else {
            console.log(`Auth utilities not found, retrying (${attempts}/${maxAttempts})...`);
            setTimeout(checkAuth, interval);
          }
        }
      };
      
      checkAuth();
    });
  }

  // Wrapper for showing status messages
  function showStatus(type, message) {
    const statusEl = document.getElementById('form-status');
    if (statusEl) {
      // Clear existing classes
      statusEl.classList.remove('hidden', 'alert-success', 'alert-error', 'alert-warning', 'alert-info');
      
      // Add new class based on type
      statusEl.classList.add('alert', `alert-${type}`);
      
      // Set the message
      statusEl.textContent = message;
      
      // Show the element
      statusEl.classList.remove('hidden');
      
      // Scroll to the status message
      statusEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    // Also show a toast notification
    if (window.showToast) {
      window.showToast(message, type);
    }
  }
  
  // Make showStatus available to the window
  window.showStatus = showStatus;
  
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("event-form");
    const submitBtn = document.getElementById("submit-btn");
    const submitText = document.getElementById("submit-text");
    const loadingSpinner = document.getElementById("loading-spinner");
    
    // Make displayInModal available to the client-side script
    console.log('Event Form - Display in modal:', displayInModal);
    
    // Add event listener for ESC key to dismiss status messages
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        // Hide form status messages
        const statusEl = document.getElementById('form-status');
        if (statusEl && !statusEl.classList.contains('hidden')) {
          statusEl.classList.add('hidden');
        }
      }
    });
    
    // Add click event to dismiss form status on click
    const statusEl = document.getElementById('form-status');
    if (statusEl) {
      statusEl.addEventListener('click', () => {
        statusEl.classList.add('hidden');
      });
    }
    
    // Form submission
    if (form) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        // Prevent duplicate submissions
        if (window.worldPianosGlobals && window.worldPianosGlobals.eventFormState.isSubmitting) {
          console.log('Form is already being submitted, ignoring duplicate submission');
          
          // Show the floating message instead of a toast
          if (window.showDuplicateSubmissionMessage) {
            window.showDuplicateSubmissionMessage();
          }
          
          return;
        }
        
        // Set submission flag
        if (window.worldPianosGlobals) {
          window.worldPianosGlobals.eventFormState.isSubmitting = true;
        }
        
        // Show loading state
        if (submitBtn && submitText && loadingSpinner) {
          submitBtn.disabled = true;
          submitText.textContent = "Sending...";
          loadingSpinner.classList.remove("hidden");
        }
        
        // Get form data
        const formData = new FormData(form);
        
        try {
          // Check for location selection
          const lat = document.getElementById("event-location-lat")?.value ||
                      document.getElementById("event-location-lat")?.getAttribute('value');
          const lng = document.getElementById("event-location-lng")?.value ||
                      document.getElementById("event-location-lng")?.getAttribute('value');
          
          if (!lat || !lng) {
            console.error('Location not selected');
            showStatus("error", "Please select a location using the map.");
            throw new Error('Location not selected');
          }
          
          console.log('Location coordinates:', { lat, lng });
          
          // Generate a unique ID for the event
          const uniqueId = `event_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
          console.log('Generated unique ID:', uniqueId);
          
          const eventData = {
            id: uniqueId,
            name: formData.get('eventName'),
            location: document.getElementById("event-location-address")?.value || 'Unknown location',
            coordinates: [
              parseFloat(lng),
              parseFloat(lat)
            ],
            date: formData.get('eventDate'),
            time: formData.get('eventTime'),
            description: formData.get('description'),
            type: formData.get('eventType'),
            piano_id: formData.get('relatedPiano'),
            status: 'upcoming',
            created_by: null // Will be set in the authentication check
          };
          
          // Check for authentication using the exposed auth utilities
          try {
            // Use the auth utilities exposed on the window with our helper function
            const { auth, profile } = await ensureAuthUtilities();
            
            // Get the current session
            const session = await auth.getSession();
            
            if (!session) {
              showStatus("error", "You must be logged in to add an event.");
              throw new Error('Authentication required');
            }
            
            // Get user ID for tracking who created the event
            const userId = session.user.id;
            
            // Set the user ID on the eventData object
            eventData.created_by = userId;
            
            // Check if admin for certain operations
            const isAdmin = await profile.isAdmin(userId);
            
            // Additional admin-only fields
            if (isAdmin) {
              eventData.verified = true;
            }
          } catch (error) {
            console.error('Authentication error:', error);
            showStatus("error", "Authentication error. Please try logging in again. You may need to refresh the page.");
            throw new Error('Authentication error');
          }
          
          // Validate all required fields are present
          const requiredFields = ['id', 'name', 'location', 'date', 'time', 'description', 'type', 'piano_id'];
          const missingFields = [];
          
          for (const field of requiredFields) {
            if (!eventData[field]) {
              missingFields.push(field);
            }
          }
          
          if (missingFields.length > 0) {
            console.error('Missing required fields:', missingFields);
            showStatus("error", "Missing required fields: " + missingFields.join(', '));
            throw new Error(`Missing required fields: ${missingFields.join(', ')}`);
          }
          
          // Validate coordinates
          if (!Array.isArray(eventData.coordinates) ||
              eventData.coordinates.length !== 2 ||
              isNaN(eventData.coordinates[0]) ||
              isNaN(eventData.coordinates[1])) {
            console.error('Invalid coordinates:', eventData.coordinates);
            showStatus("error", "Invalid coordinates. Please select a location using the map.");
            throw new Error('Invalid coordinates');
          }
          
          console.log('Submitting event data:', eventData);
          
          // Handle image upload if present
          const imageFile = formData.get('eventPicture');
          let imageUrl = null;
          
          if (imageFile && imageFile.size > 0) {
            console.log('Uploading image:', imageFile.name);
            
            // Generate a unique file name
            const fileName = `${Date.now()}-${imageFile.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
            
            try {
              // Upload to Supabase Storage
              const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
                .from('event-images')
                .upload(fileName, imageFile);
                
              if (uploadError) {
                console.error('Error uploading image:', uploadError);
                throw uploadError;
              }
              
              // Get public URL
              const { data: urlData } = window.supabaseClient.storage
                .from('event-images')
                .getPublicUrl(fileName);
                
              imageUrl = urlData.publicUrl;
              console.log('Image uploaded successfully:', imageUrl);
            } catch (error) {
              console.error('Error handling image upload:', error);
              // Continue with event creation even if image upload fails
            }
          }
          
          try {
            if (!window.supabaseClient) {
              throw new Error('Supabase client not available');
            }
            
            // Set global flag to indicate event creation is in progress
            if (window.worldPianosGlobals) {
              window.worldPianosGlobals.eventFormState.eventCreated = true;
              window.worldPianosGlobals.eventFormState.lastSubmissionTime = Date.now();
            }
            
            // Insert the event into the database
            const { data, error } = await window.supabaseClient
              .from('events')
              .insert(eventData)
              .select();
            
            if (error) {
              // Reset global flag since creation failed
              if (window.worldPianosGlobals) {
                window.worldPianosGlobals.eventFormState.eventCreated = false;
              }
              throw error;
            }
            
            console.log('Event created successfully:', data);
            
            // Store the created event ID globally
            if (window.worldPianosGlobals && data && data[0] && data[0].id) {
              window.worldPianosGlobals.eventFormState.submittedEventId = data[0].id;
              window.worldPianosGlobals.eventFormState.formSubmitted = true;
            }
            
            // If we have an image, create an event_media entry
            if (imageUrl && data && data[0] && data[0].id) {
              try {
                const { data: mediaData, error: mediaError } = await window.supabaseClient
                  .from('event_media')
                  .insert({
                    event_id: data[0].id,
                    media_type: 'image',
                    url: imageUrl,
                    description: `Primary image for ${eventData.name}`
                  });
                  
                if (mediaError) {
                  console.error('Error creating event media entry:', mediaError);
                } else {
                  console.log('Event media entry created:', mediaData);
                }
              } catch (mediaError) {
                console.error('Error creating event media entry:', mediaError);
                // Continue even if media creation fails
              }
            }
            
            // Reset form
            form.reset();
            
            // Close modals if they exist
            if (displayInModal) {
              console.log('Closing event-modal after successful submission');
              
              // Find the closest parent modal
              const eventModal = document.getElementById('event-modal');
              if (eventModal && 'close' in eventModal) {
                // Close the modal
                eventModal.close();
              }
              
              // Notify the parent window if in a modal
              if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                  type: 'event-added',
                  eventId: data[0].id,
                  eventName: data[0].name
                }, '*');
              }
              
              // Show a success toast
              if (window.showToast) {
                window.showToast(`Event "${data[0].name}" added successfully!`, 'success');
              }
              
              // Redirect to the event details page instead of reloading
              setTimeout(() => {
                window.location.href = `/events/${data[0].id}`;
              }, 1000);
            } else {
              // Show a success toast
              if (window.showToast) {
                window.showToast(`Event "${data[0].name}" added successfully!`, 'success');
              }
              
              // Redirect to event details page after a short delay
              setTimeout(() => {
                window.location.href = `/events/${data[0].id}`;
              }, 1500);
            }
          } catch (error) {
            console.error('Error creating event:', error);
            
            // Handle specific error types
            if (error.code === '42501' || error.message?.includes('permission')) {
              showStatus("error", "Permission denied: You may need to log in to add an event");
            } else if (error.code === '23505') {
              showStatus("error", "An event with this information already exists");
            } else if (error.code === '23502') {
              showStatus("error", "Missing required fields: " + (error.details || ''));
            } else {
              showStatus("error", `Error creating event: ${error.message || 'Unknown error'}`);
            }
          }
        } catch (error) {
          // Show detailed error message
          console.error("Form submission error:", error);
          
          let errorMessage = "There was an error submitting the form. Please try again.";
          
          // Provide more specific error messages based on the error type
          if (error.message) {
            if (error.message.includes('Location not selected')) {
              errorMessage = "Please select a location using the map.";
            } else if (error.message.includes('permission') || error.message.includes('access')) {
              errorMessage = "Permission denied. You may need to log in or check your access rights.";
            } else if (error.message.includes('network') || error.message.includes('connection')) {
              errorMessage = "Network error. Please check your internet connection.";
            } else if (error.message.includes('validation')) {
              errorMessage = "Validation error. Please check your form inputs.";
            } else if (error.message.includes('bucket')) {
              errorMessage = "Error with image storage. Please try again or skip adding an image.";
            }
          }
          
          // Show the error message
          showStatus("error", errorMessage);
          
          // Log detailed error information to console
          console.error("Detailed error:", {
            message: error.message,
            stack: error.stack,
            code: error.code,
            details: error.details
          });
        } finally {
          // Reset button state
          if (submitBtn && submitText && loadingSpinner) {
            submitBtn.disabled = false;
            submitText.textContent = "Submit";
            loadingSpinner.classList.add("hidden");
          }
          
          // Reset submission flag after a short delay
          setTimeout(() => {
            if (window.worldPianosGlobals) {
              window.worldPianosGlobals.eventFormState.isSubmitting = false;
            }
          }, 500);
        }
      });
    }
  });
</script>