---
import MainLayout from "../layouts/MainLayout.astro";
---

<MainLayout>
  <div class="container mx-auto px-4 py-8 text-center">
    <h1 class="text-2xl font-bold mb-6">Completing Authentication...</h1>
    <div class="loading loading-spinner loading-lg"></div>
  </div>
</MainLayout>

<script>
  import { auth, profile } from '../utils/auth';
  
  // Handle the auth callback
  async function handleAuthCallback() {
    try {
      // Get the current session
      const session = await auth.getSession();
      
      if (!session) {
        console.error('Auth callback: No session found');
        window.location.href = '/auth?error=No session found';
        return;
      }
      
      const user = session.user;
      
      // Check if user profile exists and create if needed
      if (user) {
        const userProfile = await profile.getUserProfile(user.id);
        
        if (!userProfile) {
          console.log('Auth callback: Creating profile for user:', user.id);
          
          // Get user metadata
          const metadata = user.user_metadata || {};
          const displayName = metadata.display_name || user.email?.split('@')[0] || 'User';
          
          // Create profile via API
          try {
            const result = await profile.createUserProfileViaApi(user.id, displayName);
            
            if (!result.success) {
              console.error('Auth callback: Error creating profile via API:', result.error);
              // Continue with redirect despite error
            } else {
              console.log('Auth callback: User profile created successfully via API');
            }
          } catch (apiError) {
            console.error('Auth callback: API call error:', apiError);
            // Continue with redirect despite error
          }
        }
      }
      
      // Log successful authentication
      console.log('Auth callback successful, session established:', {
        userId: user?.id,
        hasSession: !!session,
        expiresAt: session?.expires_at
      });
      
      // Redirect to the return URL
      const returnTo = auth.getReturnUrl();
      console.log('Redirecting to:', returnTo);
      
      // Add a slight delay to ensure session is established
      setTimeout(() => {
        window.location.href = returnTo;
      }, 1000);
    } catch (error) {
      console.error('Auth callback error:', error);
      window.location.href = '/auth?error=Authentication failed';
    }
  }
  
  // Run the handler
  handleAuthCallback();
</script>