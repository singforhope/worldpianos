---
import MainLayout from "../layouts/MainLayout.astro";
import { getAllPianos, getAllEvents } from "../utils/dataService";
import type { Piano, Event } from "../utils/dataService";

// Get search parameters
const searchQuery = Astro.url.searchParams.get("q") || "";
const searchType = Astro.url.searchParams.get("type") || "pianos";

// Initialize results
let pianos: Piano[] = [];
let events: Event[] = [];
let results: any[] = [];
let totalResults = 0;

// Only perform search if there's a query
if (searchQuery && searchQuery.length >= 2) {
  try {
    // Fetch data based on the selected search type
    if (searchType === "pianos") {
      pianos = await getAllPianos();
      results = pianos.filter(
        (piano) =>
          (piano.name || "").toLowerCase().includes(searchQuery.toLowerCase()) ||
          (piano.location || "").toLowerCase().includes(searchQuery.toLowerCase()) ||
          (piano.city || "").toLowerCase().includes(searchQuery.toLowerCase()) ||
          (piano.country || "").toLowerCase().includes(searchQuery.toLowerCase())
      );
    } else if (searchType === "events") {
      events = await getAllEvents();
      results = events.filter(
        (event) =>
          (event.name || "").toLowerCase().includes(searchQuery.toLowerCase()) ||
          (event.location || "").toLowerCase().includes(searchQuery.toLowerCase()) ||
          (event.description || "").toLowerCase().includes(searchQuery.toLowerCase())
      );
    }
    
    totalResults = results.length;
  } catch (error) {
    console.error("Search error:", error);
  }
}
---

<MainLayout>
  <div class="container mx-auto p-4">
    <div class="mb-8">
      <h1 class="text-3xl font-bold mb-4">Search Results</h1>
      
      <!-- Search Form -->
      <form class="form-control w-full max-w-xl mb-8" action="/search" method="get">
        <div class="flex flex-col sm:flex-row w-full gap-2">
          <div class="join w-full">
            <select class="select select-bordered join-item" name="type">
              <option value="pianos" selected={searchType === "pianos"}>Pianos</option>
              <option value="events" selected={searchType === "events"}>Events</option>
            </select>
            <input
              type="text"
              name="q"
              value={searchQuery}
              placeholder="Enter keywords to search..."
              class="input input-bordered join-item flex-grow"
            />
            <button type="submit" class="btn btn-primary join-item">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                ></path>
              </svg>
              Search
            </button>
          </div>
        </div>
      </form>
      
      <!-- Search Summary -->
      {searchQuery && (
        <div class="text-base-content/70 mb-4">
          {totalResults > 0 ? (
            <p>Found {totalResults} {totalResults === 1 ? (searchType === "pianos" ? "piano" : "event") : (searchType === "pianos" ? "pianos" : "events")} matching "{searchQuery}"</p>
          ) : (
            <p>No results found for "{searchQuery}" in {searchType}.</p>
          )}
        </div>
      )}
      
      {!searchQuery && (
        <div class="text-base-content/70 mb-4">
          <p>Please enter a search term to find {searchType}.</p>
        </div>
      )}
    </div>
    
    {searchType === "pianos" && totalResults > 0 && (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {results.map((piano) => (
          <div class="card card-compact bg-base-100 shadow-xl h-full">
            <figure class="h-48 bg-base-200">
              <img 
                src="/images/piano-placeholder.jpg" 
                alt={piano.name || "Piano"} 
                class="w-full h-full object-cover"
              />
            </figure>
            <div class="card-body">
              <h2 class="card-title">{piano.name || "Unnamed Piano"}</h2>
              <p class="text-sm">
                {piano.type || "Unknown type"}
              </p>
              <p class="text-sm">
                {piano.city || ""}{piano.city && piano.country ? ", " : ""}{piano.country || ""}
              </p>
              <div class="card-actions justify-end mt-2">
                <a href={`/pianos/${piano.id}`} class="btn btn-primary btn-sm">View Details</a>
              </div>
            </div>
          </div>
        ))}
      </div>
    )}
    
    {searchType === "events" && totalResults > 0 && (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {results.map((event) => (
          <div class="card card-compact bg-base-100 shadow-xl h-full">
            <div class="card-body">
              <h2 class="card-title">{event.name || "Unnamed Event"}</h2>
              <p class="text-sm">
                {new Date(event.date).toLocaleDateString()} at {event.time || "TBD"}
              </p>
              <p class="text-sm">
                {event.location || "Location not specified"}
              </p>
              <p class="text-sm line-clamp-2">
                {event.description || "No description available"}
              </p>
              <div class="card-actions justify-end mt-2">
                <a href={`/events/${event.id}`} class="btn btn-primary btn-sm">View Details</a>
              </div>
            </div>
          </div>
        ))}
      </div>
    )}
    
    {totalResults === 0 && searchQuery && (
      <div class="text-center py-12">
        <div class="mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-base-content/30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        <h2 class="text-2xl font-semibold mb-2">No results found</h2>
        <p class="text-base-content/70 max-w-md mx-auto">
          We couldn't find any {searchType} matching "{searchQuery}". Try different keywords or browse all {searchType}.
        </p>
        <div class="mt-6">
          <a href={`/${searchType}`} class="btn btn-primary">Browse All {searchType.charAt(0).toUpperCase() + searchType.slice(1)}</a>
        </div>
      </div>
    )}
  </div>
</MainLayout> 